<!doctype html>
<html lang="en">
	<head>
		<title>SmartPot</title>
		<!-- Required meta tags -->
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1, shrink-to-fit=no"
		/>

		<!-- Bootstrap CSS v5.2.1 -->
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
			crossorigin="anonymous"
		/>
		<link rel="stylesheet" href="style.css">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
	</head>

	<body>
		<header>
			<div class="container-fluid">
				<nav class="navbar navbar-expand-lg my-3 h-97 py-3 px-3 rounded bg-white">
					<div class="d-flex align-items-center">
						<h3 id="helloMsg"></h3>
					</div>
					
					<ul class="navbar-nav ms-auto mb-lg-0">
						<li class="nav-item">
							<button class="btn btn-success rounded-full fs-5" id="configBtn"><i class="bi bi-gear-fill"></i></button>
						</li>
						<li class="nav-item">
							<button class="btn btn-danger rounded-full fs-5" id="signOutBtn"><i class="bi bi-power"></i></button>
						</li>
					</ul>
				</nav>
			</div>
		</header>
		<main>
			<!-- Page Content -->
			<div class="container px-3 py-3 h-97 rounded my-2">
				<div class="row mb-1">
					<h3 class="primary-text">Trạng thái</h3>
				</div>
				<div class="row g-3 mb-2">
					<div class="col-md-3">
						<div class="p-3 bg-white shadow-sm d-flex justify-content-around align-items-center rounded">
							<i class="fs-1 primary-text bi bi-thermometer-half"></i>
							<div>
								<p class="fs-5">Nhiệt độ</p>
								<h3 class="fs-2 value" id="temperature">0000</h3>
							</div>
						</div>
					</div>

					<div class="col-md-3">
						<div class="p-3 bg-white shadow-sm d-flex justify-content-around align-items-center rounded">
							<i class="fs-1 primary-text bi bi-brightness-alt-high"></i>
							<div>
								<p class="fs-5">Ánh sáng</p>
								<h3 class="fs-2 value" id="light">0000</h3>
							</div>
						</div>
					</div>

					<div class="col-md-3">
						<div class="p-3 bg-white shadow-sm d-flex justify-content-around align-items-center rounded">
							<i class="fs-1 primary-text bi bi-moisture"></i>
							<div>
								<p class="fs-5">Độ ẩm đất</p>
								<h3 class="fs-2 value" id="moisture">0000</h3>
							</div>
						</div>
					</div>				
				</div>
			</div>
			<div class="container px-3 py-3 rounded">
				<div class="row mb-1">
					<h3>Biểu đồ</h3>
				</div>
				<div class="row mb-5">
					<div class="col-lg-5 col-md-10 col-sm-10">
						<div>
							<canvas id="dailyChart"></canvas>
						</div>
					</div>
					<div class="col-lg-5 col-md-10 col-sm-10">
						<div>
							<canvas id="weeklyChart"></canvas>
						</div>
					</div>
				</div>
			</div>

		</main>
		<footer>
			<!-- place footer here -->
		</footer>
		<!-- Bootstrap JavaScript Libraries -->
		<script
			src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
			integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
			crossorigin="anonymous"
		></script>

		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
			integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
			crossorigin="anonymous"
		></script>

		<script>
			let UserCreds = JSON.parse(sessionStorage.getItem("user-creds"));
			let UserInfo = JSON.parse(sessionStorage.getItem("user-info"));

			let helloMsg = document.getElementById("helloMsg");
			let signOutBtn = document.getElementById("signOutBtn");

			let signOut = () => {
				sessionStorage.removeItem("user-creds");
				sessionStorage.removeItem("user-info");
				window.location.href = 'login.html';
			}

			let checkCred = () => {
				if (!sessionStorage.getItem("user-creds"))
					window.location.href = 'login.html';
				else {
					console.log(sessionStorage.getItem("user-creds"));
					helloMsg.innerText = `Xin chào, ${UserInfo.name}`;
				}
			}
			window.addEventListener('load', checkCred);
			signOutBtn.addEventListener('click', signOut);
		</script>

		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

		<!-- Firebase -->

		<script type="module">
			// Import the functions you need from the SDKs you need
			import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
			import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
			import { getFirestore, doc, setDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
			const firebaseConfig = {
			apiKey: "AIzaSyCAd8obhPga8Bj6WQa24OptLX1R39wMUT4",
			authDomain: "smartpot-daf58.firebaseapp.com",
			databaseURL: "https://smartpot-daf58-default-rtdb.asia-southeast1.firebasedatabase.app",
			projectId: "smartpot-daf58",
			storageBucket: "smartpot-daf58.appspot.com",
			messagingSenderId: "1021845898220",
			appId: "1:1021845898220:web:b3c85c3bbf071a2113b6c9",
			measurementId: "G-PM8156BQ8Z"
			};

			// Initialize Firebase
			const app = initializeApp(firebaseConfig);


			// getting reference to the database
			const database = getDatabase(app);
			const db = getFirestore(app)

			const colRef = collection(db, 'DailyStatus');
			// Get all documents in the collection
			const snapshot = await getDocs(colRef);
			
			//getting reference to the data we want
			let currentHour = new Date().getHours();
			setInterval(() => {
				currentHour = new Date().getHours();
			}, 60 * 60 * 1000);
			var dataRef1 = ref(database, 'Status/Temperature');
			var docRef = doc(db, `DailyStatus/${currentHour}`);
			var dataRef2 = ref(database, 'Status/Light');
			var dataRef3 = ref(database, 'Status/Moisture');

			//fetch the data
			let dailyData = [];
			let tempData = [];
			let tempSum = 0;
			let count = 0;
			onValue(dataRef1, (snapshot) => {
				var temp = snapshot.val();
				document.getElementById('temperature').innerHTML = temp + "&#8451;";
			});
			setInterval(() => {
				onValue(dataRef1, async (snapshot) => {
					var temp = snapshot.val();
					let newHour = new Date().getHours();
						if (newHour !== currentHour) {
					let avgTemp = tempSum / count;
					await setDoc(docRef, {AvgTemp: avgTemp});
					dailyData.push(avgTemp);
					// Reset the data
					tempData = [];
					tempSum = 0;
					count = 0;
					currentHour = newHour;
					// If a new day has started
					if (newHour === 0) {
						// Reset the collection
						snapshot.docs.forEach((doc) => {
							deleteDoc(doc.ref);
						});
						
					}
				}
					tempData.push(temp);
					tempSum += temp;
					count++;
				});
			}, 30 * 1000);
			onValue(dataRef2, async (snapshot) => {
				var light = snapshot.val();
				document.getElementById('light').innerHTML = light + "%";
			});
			
			onValue(dataRef3, (snapshot) => {
				var mois = snapshot.val();
				document.getElementById('moisture').innerHTML = mois + "%";
			});

			const dailydata = {
				labels: ['0','1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11',
		  		   '12','13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23'],
				datasets: [{
					label: 'Nhiệt độ',
					data: dailyData,
					backgroundColor: [
						'rgba(255, 26, 104, 0.2)',
					],
					borderColor: [
						'rgba(255, 26, 104, 1)',
					],
					tension: 0.4,
				},
				{
					label: 'Độ ẩm',
					data: [8, 2, 16, 7, 1, 4, 6],
					backgroundColor: [
						'rgba(0, 0, 0, 0.2)'
					],
					borderColor: [
						'rgba(0, 0, 0, 1)'
					],
					tension: 0.4,
					yAxisID: 'percentage'
				}]
			};

			// config 
			const dailyconfig = {
			type: 'line',
			data: dailydata,
			options: {
				scales: {
				y: {
					beginAtZero: true,
					title: {
						display: true,
						text: 'Độ C'
					}
				},
				percentage: {
					beginAtZero: true,
					position: 'right',
					title: {
						display: true,
						text: '%'
					}
				}
				}
			}
			};
		
			// render init block
			const dailyChart = new Chart(
			document.getElementById('dailyChart'),
			dailyconfig
			);
			
		</script>

		<!-- Chart -->
		<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
		<script>
			// setup 
			const weeklydata = {
			  labels: ['Hai', 'Ba', 'Tư', 'Năm', 'Sáu', 'Bảy', 'CN'],
			  datasets: [{
				label: 'Nhiệt độ',
				data: [18, 12, 6, 9, 12, 3, 9],
				backgroundColor: [
				  'rgba(255, 26, 104, 0.2)',
				],
				borderColor: [
				  'rgba(255, 26, 104, 1)',
	
				],
				tension: 0.4,
			  },
			  {
				label: 'Độ ẩm',
				data: [8, 2, 16, 7, 1, 4, 6],
				backgroundColor: [
				  'rgba(0, 0, 0, 0.2)'
				],
				borderColor: [
				  'rgba(0, 0, 0, 1)'
				],
				tension: 0.4,
				yAxisID: 'percentage'
			  }]
			};
		
			// config 
			const weeklyconfig = {
			  type: 'line',
			  data: weeklydata,
			  options: {
				scales: {
				  y: {
					beginAtZero: true,
					title: {
						display: true,
						text: 'Độ C'
					}
				  },
				  percentage: {
					beginAtZero: true,
					position: 'right',
					title: {
						display: true,
						text: '%'
					}
				  }
				}
			  }
			};
		
			// render init block
			var weeklyChart = new Chart(
			  document.getElementById('weeklyChart'),
			  weeklyconfig
			);
		</script>
	</body>

</html>
